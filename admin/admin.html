<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Administrador - Conversor de Moneda</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="estilo.css">
</head>
<body>
    <div class="container">
        <h1>Administrador - Conversor de Moneda</h1>
        
        <!-- Sección de Transferencias -->
        <h2>Transferencias</h2>
        <label for="minAmountTransfer">Monto Mínimo:</label>
        <input type="number" id="minAmountTransfer" step="0.01" required>
        <label for="maxAmountTransfer">Monto Máximo:</label>
        <input type="number" id="maxAmountTransfer" step="0.01" required>
        <label for="exchangeRateTransfer">Tasa de Cambio:</label>
        <input type="number" id="exchangeRateTransfer" step="0.01" required>
        <button id="saveButtonTransfer">Guardar Tasa de Transferencia</button>
        <div class="exchange-rates" id="exchangeRatesTransfer"></div>

        <!-- Sección de Depósitos -->
        <h2>Depósitos</h2>
        <label for="minAmountDeposit">Monto Mínimo:</label>
        <input type="number" id="minAmountDeposit" step="0.01" required>
        <label for="maxAmountDeposit">Monto Máximo:</label>
        <input type="number" id="maxAmountDeposit" step="0.01" required>
        <label for="exchangeRateDeposit">Tasa de Cambio:</label>
        <input type="number" id="exchangeRateDeposit" step="0.01" required>
        <button id="saveButtonDeposit">Guardar Tasa de Depósito</button>
        <div class="exchange-rates" id="exchangeRatesDeposit"></div>

        <!-- Botón para limpiar todos los registros -->
        <button id="clearAllButton">Limpiar Todos los Registros</button>

        <br><br>
        <a href="index.html">Ir a inicio</a>
    </div>

    <script>
        const SHEETS_API_URL = 'https://spreadsheets.google.com/feeds/list/1tbN3YG5ZdhsTfgRisBrhoCzcYD-5q8nhnoeeu5Ptl2E/1/public/values?alt=json';

        async function fetchData() {
            try {
                const response = await fetch(SHEETS_API_URL);
                const data = await response.json();
                const rows = data.feed.entry.map(entry => ({
                    Monto_minimo: entry.gsx$montominimo ? entry.gsx$montominimo.$t : '',
                    Monto_maximo: entry.gsx$montomaximo ? entry.gsx$montomaximo.$t : '',
                    Tasa_cambio: entry.gsx$tasacambio ? entry.gsx$tasacambio.$t : '',
                    Tipo: entry.gsx$tipo ? entry.gsx$tipo.$t : ''
                }));
                displayExchangeRates(rows, 'Transfer');
                displayExchangeRates(rows, 'Deposit');
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Hubo un problema al obtener los datos. Por favor, inténtalo de nuevo más tarde.');
            }
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function displayExchangeRates(rates, type) {
            const exchangeRatesContainer = document.getElementById(`exchangeRates${type}`);
            exchangeRatesContainer.innerHTML = '';
            rates.forEach((rate, index) => {
                if (rate.Tipo && rate.Tipo.toLowerCase() === type.toLowerCase()) {
                    const sanitizedMinAmount = sanitizeInput(rate.Monto_minimo);
                    const sanitizedMaxAmount = sanitizeInput(rate.Monto_maximo);
                    const sanitizedExchangeRate = sanitizeInput(rate.Tasa_cambio);
                    const sanitizedType = sanitizeInput(rate.Tipo);
                    
                    const exchangeRateDiv = document.createElement('div');
                    exchangeRateDiv.classList.add('exchange-rate');
                    exchangeRateDiv.innerHTML = `
                        <span>Min: ${sanitizedMinAmount}, Max: ${sanitizedMaxAmount}, Tasa: ${sanitizedExchangeRate}, Tipo: ${sanitizedType}</span>
                        <button onclick="deleteExchangeRate(${index}, '${type}')">Eliminar</button>
                    `;
                    exchangeRatesContainer.appendChild(exchangeRateDiv);
                }
            });
        }

        async function deleteExchangeRate(index, type) {
            // Implementa tu lógica de eliminación aquí
        }

        function saveExchangeRate(type) {
            const minAmount = parseFloat(document.getElementById(`minAmount${type}`).value);
            const maxAmount = parseFloat(document.getElementById(`maxAmount${type}`).value);
            const exchangeRate = parseFloat(document.getElementById(`exchangeRate${type}`).value);

            if (!minAmount || !maxAmount || !exchangeRate) {
                alert(`Por favor, complete todos los campos en ${type}.`);
                return;
            }

            const exchangeRates = JSON.parse(localStorage.getItem(`exchangeRates${type}`)) || [];

            const isRangeRepeated = exchangeRates.some(rate => {
                return (minAmount >= rate.minAmount && minAmount <= rate.maxAmount) ||
                       (maxAmount >= rate.minAmount && maxAmount <= rate.maxAmount) ||
                       (minAmount <= rate.minAmount && maxAmount >= rate.maxAmount);
            });

            if (isRangeRepeated) {
                alert(`El rango de montos ya existe en ${type}. Por favor, elija un rango diferente.`);
                return;
            }

            exchangeRates.push({ minAmount, maxAmount, exchangeRate });
            localStorage.setItem(`exchangeRates${type}`, JSON.stringify(exchangeRates));
            alert(`¡Tasa de cambio guardada en ${type}!`);
            displayExchangeRates(exchangeRates, type);
        }

        document.getElementById("saveButtonTransfer").addEventListener("click", () => saveExchangeRate('Transfer'));
        document.getElementById("saveButtonDeposit").addEventListener("click", () => saveExchangeRate('Deposit'));

        function clearAllRecords() {
            localStorage.removeItem('exchangeRatesTransfer');
            localStorage.removeItem('exchangeRatesDeposit');
            alert("¡Todos los registros han sido limpiados!");
            displayExchangeRates([], 'Transfer');
            displayExchangeRates([], 'Deposit');
        }

        document.getElementById("clearAllButton").addEventListener("click", clearAllRecords);

        window.onload = function() {
            fetchData();
            displayExchangeRates([], 'Transfer');
            displayExchangeRates([], 'Deposit');
        };
    </script>
</body>
</html>
